{
  "apps" : [{
    "name"      : "API",
    "script"    : "app.js",
    "env_production": {
      "NODE_ENV": "development",
    }
  },{
    "name"      : "WEB",
    "script"    : "web.js",
    "env_production": {
      "NODE_ENV": "development",
    }
  }],
  "deploy" : {
    "production" : {
      "user" : "node",
      "host" : "212.83.163.1",
      "repo" : "git@github.com:repo.git",
      "ref"  : "origin/master",
      "path" : "/var/www/production",
      "post-deploy" : "pm2 startOrRestart ecosystem.json --env production"
    },
    "dev" : {
      "user" : "node",
      "host" : "212.83.163.1",
      "repo" : "git@github.com:repo.git",
      "ref"  : "origin/master",
      "path" : "/var/www/development",
      "post-deploy" : "pm2 startOrRestart ecosystem.json --env production"
    }
  }
}


tasks:
  - name:                 stop mangal apps
    command:              pm2 delete all
    become:               true
    become_user:          mangal
    ignore_errors:        yes
  - name:                 start orcid-oauth2
    command:              pm2 start ~/orcid-oauth2/index.js --name orcid-oauth2
    become:               true
    become_user:          mangal
    environment:
      ORCID_CLIENTID:     "{{ ORCID_CLIENTID }}"
      ORCID_CLIENTSECRET: "{{ ORCID_CLIENTSECRET }}"
      ORCID_CALLBACK:     "{{ ORCID_CALLBACK }}"
      PORT_MANGAL_OAUTH:  "{{ PORT_MANGAL_OAUTH }}"
  - name:                 start mangal-api
    command:              pm2 start ~/mangal-api/index.js --name mangal-api
    environment:
      PORT_MANGAL_API:    "{{ PORT_MANGAL_API }}"
    become:               true
    become_user:          mangal
  - name:                 installing startup script
    become:               yes
    become_method:        sudo
    shell:                env PATH=$PATH:/usr/bin /usr/local/lib/node_modules/pm2/bin/pm2 startup systemd -u mangal --hp /var/mangal
    notify:
      - start pm2
